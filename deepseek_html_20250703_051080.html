<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Fall Simulator</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00796b',
                        secondary: '#b2dfdb',
                        accent: '#ff6f00',
                        dark: '#004d40',
                        light: '#e0f2f1',
                        error: '#e53e3e',
                        success: '#38a169'
                    },  
                    borderRadius: {
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: '8px',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                        'button': '8px'
                    },
                    boxShadow: {
                        'soft': '0 10px 30px -15px rgba(0, 0, 0, 0.1)',
                        'hard': '0 10px 30px -10px rgba(0, 0, 0, 0.2)'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * {
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }
        
        h1, h2, h3, h4 {
            font-weight: 700;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* COMPACT UI */
        .compact-header {
            padding: 0.75rem 0;
        }
        
        .compact-section {
            padding: 2rem 0;
        }
        
        .compact-card {
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .compact-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .compact-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2d3748;
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #cbd5e0;
            background: #fff;
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            border-color: #00796b;
            box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.2);
            outline: none;
        }
        
        .output-field {
            background-color: #f0f9ff;
            border-color: #00796b;
            color: #004d40;
            font-weight: 500;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00796b 0%, #004d40 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 121, 107, 0.3);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 15px rgba(0, 121, 107, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #ff6f00 0%, #e65100 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 111, 0, 0.3);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 6px 15px rgba(255, 111, 0, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-gray {
            background: #edf2f7;
            color: #4a5568;
        }
        
        .btn-gray:hover {
            background: #e2e8f0;
        }
        
        .simulation-container {
            position: relative;
            height: 400px;
            overflow: hidden;
            border-radius: 8px;
            margin-top: 1rem;
            background-color: #f0f9ff;
            border: 1px solid #b2dfdb;
        }
        
        #simulationCanvas {
            width: 100%;
            height: 100%;
        }
        
        .section-title {
            position: relative;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #00796b 0%, #ff6f00 100%);
            border-radius: 2px;
        }
        
        .equation-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #00796b;
        }
        
        .equation {
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            color: #004d40;
            line-height: 1.6;
        }
        
        .result-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .result-card {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .result-card.highlight {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 121, 107, 0.2);
            border-color: #00796b;
        }
        
        .result-card.calculated {
            background-color: rgba(56, 161, 105, 0.1);
            border: 2px solid #38a169;
        }
        
        .result-label {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 0.25rem;
        }
        
        .result-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #00796b;
        }
        
        .result-unit {
            font-size: 0.85rem;
            color: #a0aec0;
        }
        
        .compact-nav {
            display: flex;
            gap: 1.25rem;
        }
        
        .compact-nav a {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            position: relative;
            padding: 0.25rem 0;
        }
        
        .compact-nav a:hover {
            color: white;
        }
        
        .compact-nav a::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: white;
            transition: width 0.3s ease;
        }
        
        .compact-nav a:hover::after {
            width: 100%;
        }
        
        .progress-bar {
            height: 6px;
            background: #e0f2f1;
            border-radius: 3px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-value {
            height: 100%;
            background: #00796b;
            transition: width 0.2s;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .status-ready {
            background-color: #38a169;
        }
        
        .status-running {
            background-color: #3182ce;
        }
        
        .status-ended {
            background-color: #e53e3e;
        }
        
        .simulation-data {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.85);
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #b2dfdb;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 0.85rem;
        }
        
        .simulation-control-icon {
            position: absolute;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid #b2dfdb;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .simulation-control-icon:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: scale(1.05);
        }
        
        #pauseResumeIcon {
            top: 10px;
            right: 55px;
        }
        
        #replayIcon {
            top: 10px;
            right: 10px;
        }
        
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 6px;
        }
        
        .tooltip-icon {
            color: #00796b;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .tooltip-content {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #004d40;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 6px 10px;
            width: 180px;
            font-size: 0.8rem;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .tooltip-container:hover .tooltip-content {
            opacity: 1;
        }
        
        .active-equation {
            background: #f7fafc;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1.5rem;
            border-left: 4px solid #ff6f00;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .equation-value {
            color: #ff6f00;
            font-weight: 600;
        }
        
        .compact-hero {
            padding: 4rem 0;
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.1) 0%, rgba(178, 223, 219, 0.15) 100%);
        }
        
        .compact-footer {
            padding: 2rem 0;
        }
        
        .results-heading {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
        .results-heading i {
            font-size: 1.5rem;
            color: #00796b;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.1) 0%, rgba(178, 223, 219, 0.15) 100%);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #00796b;
            margin-top: 1.5rem;
        }
        
        /* Animation classes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        
        @keyframes highlight {
            0% { transform: scale(1); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
            50% { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0, 121, 107, 0.3); }
            100% { transform: scale(1); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
        }
        
        .highlight-animation {
            animation: highlight 1s ease;
        }
        
        /* Improved slider layout */
        .slider-container {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 25;
            display: flex;
            flex-direction: row;
            gap: 15px;
        }
        
        .slider-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px 10px;
            border-radius: 12px;
            border: 1px solid #b2dfdb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .slider-label {
            font-size: 0.9rem;
            color: #004d40;
            font-weight: 500;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .slider-value-display {
            font-size: 0.9rem;
            font-weight: 600;
            color: #00796b;
            margin-top: 8px;
            min-width: 50px;
            text-align: center;
        }
        
        .simulation-slider.vertical {
            -webkit-appearance: slider-vertical;
            writing-mode: bt-lr;
            width: 8px;
            height: 150px;
            padding: 0 10px;
        }
        
        .simulation-slider.vertical::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00796b;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .simulation-slider.vertical::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00796b;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Control buttons at bottom-left */
        .simulation-buttons {
            display: flex;
            gap: 10px;
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 30;
        }
        
        .sim-btn {
            background: #00796b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }
        
        .sim-btn:hover {
            background: #004d40;
            transform: scale(1.05);
        }
        
        .input-section {
            margin-bottom: 1.5rem;
        }
        
        .calculation-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-top: 1.5rem;
        }
        
        .calculation-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #004d40;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .calculation-result {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ff6f00;
            margin: 0.5rem 0;
        }
        
        .calculation-details {
            color: #4a5568;
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }
        
        .input-error {
            border-color: #e53e3e;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.2);
        }
        
        .error-message {
            color: #e53e3e;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .simulation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .simulation-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #004d40;
        }
        
        .simulation-subtitle {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 0.25rem;
        }
        
        .simulation-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .simulation-stats {
            display: flex;
            gap: 15px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f0f9ff;
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 80px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #718096;
        }
        
        .stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: #004d40;
        }
        
        /* Ball data display */
        .ball-data-display {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #b2dfdb;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.8rem;
            z-index: 15;
            pointer-events: none;
            min-width: 100px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: opacity 0.3s;
            display: none;
            color: #000;
        }
        
        .ball-data-display div {
            line-height: 1.4;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .slider-container {
                flex-direction: row;
                right: 10px;
                top: auto;
                bottom: 10px;
                transform: none;
                gap: 10px;
            }
            
            .slider-group {
                padding: 10px;
                height: auto;
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            
            .simulation-slider.vertical {
                height: 100px;
                writing-mode: horizontal-tb;
                width: 100px;
                height: 8px;
            }
            
            .slider-label {
                margin-bottom: 0;
                margin-right: 8px;
            }
            
            .slider-value-display {
                margin-top: 0;
                margin-left: 8px;
            }
        }

        /* Added for Go to Simulation button */
        .go-to-simulation-container {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }
        
        /* Compact layout enhancements */
        .calculator-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .section-title-container {
            position: relative;
            width: 100%;
        }
        
        .results-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Highlighted text */
        .highlight-text {
            background: linear-gradient(120deg, rgba(255, 247, 133, 0.5), rgba(255, 247, 133, 0.5));
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* Input dependency helper */
        .input-helper {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 6px;
            display: none;
        }
        
        /* Equation styling */
        .equation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Unit note */
        .unit-note {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 6px;
        }
        
        /* Platform styling */
        .platform {
            position: absolute;
            background: #8d6e63;
            height: 10px;
            border-radius: 4px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16);
            z-index: 5;
        }
        
        /* Cloud styling */
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1;
        }

        /* Toggle styles */
        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 0;
        }

        .toggle-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .toggle-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .toggle-content.expanded {
            max-height: 1000px;
            opacity: 1;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Compact Header -->
    <header class="bg-gradient-to-r from-dark to-primary shadow-md sticky top-0 z-50 compact-header">
        <div class="container mx-auto px-4 flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-8 h-8 flex items-center justify-center mr-3 bg-white/20 rounded-full">
                    <i class="ri-calculator-line text-white"></i>
                </div>
                <h1 class="text-xl font-bold text-white">Free Fall Simulator</h1>
            </div>
            <nav>
                <ul class="compact-nav">
                    <li><a href="#home">Home</a></li>
                    <li><a href="#calculator">Calculator</a></li>
                    <li><a href="#concept">Concept</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section id="home" class="compact-hero">
            <div class="container mx-auto px-4 py-12">
                <div class="max-w-4xl mx-auto text-center">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">Free Fall Simulator</h1>
                    <p class="text-gray-700 mb-8">Calculate free fall parameters with precision and visualize the motion with interactive simulations</p>
                    <div class="flex flex-wrap justify-center gap-3">
                        <a href="#calculator" class="btn btn-primary whitespace-nowrap">
                            <i class="ri-calculator-line mr-2"></i>
                            Get Started
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Calculator Section -->
        <section id="calculator" class="compact-section bg-gray-50">
            <div class="calculator-container px-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-8">Free Fall Calculator</h2>
                
                <div class="unit-note">
                    <i class="ri-information-line mr-2"></i> All inputs must be in base units: meters (m) and seconds (s).
                </div>
                
                <div class="compact-card">
                    <div class="section-header">
                        <div class="section-title-container">
                            <h3 class="section-title text-xl font-bold text-gray-800">Input Parameters</h3>
                        </div>
                    </div>
                    
                    <div id="calculatorSection">
                        <div class="compact-grid">
                            <!-- Inputs Column -->
                            <div>
                                <div class="input-group">
                                    <label class="input-label">Acceleration due to gravity (g) <span class="text-gray-500 ml-1">(m/s²)</span></label>
                                    <select id="gravitySelect" class="input-field">
                                        <option value="9.8">Earth (9.8 m/s²)</option>
                                        <option value="1.62">Moon (1.62 m/s²)</option>
                                        <option value="3.72">Mars (3.72 m/s²)</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                    <div id="customGravityContainer" class="mt-2 hidden">
                                        <input type="number" id="customGravity" placeholder="Enter gravity value" class="input-field">
                                        <p class="error-message" id="gravityError">Must be positive value</p>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <div class="input-label">
                                        Initial Velocity (v₀) <span class="text-gray-500 ml-1">(m/s)</span>
                                        <div class="tooltip-container ml-2">
                                            <i class="ri-information-line tooltip-icon"></i>
                                            <div class="tooltip-content">
                                                Velocity at the start of fall. Positive = downward, Negative = upward
                                            </div>
                                        </div>
                                    </div>
                                    <input type="number" id="initialVelocity" class="input-field" placeholder="e.g., 0" value="0">
                                    <p class="error-message" id="initialVelocityError"></p>
                                </div>
                                
                                <div class="input-section" id="heightInputSection">
                                    <div class="input-label">
                                        Initial Height from Ground (h₀) <span class="text-gray-500 ml-1">(m)</span>
                                        <div class="tooltip-container ml-2">
                                            <i class="ri-information-line tooltip-icon"></i>
                                            <div class="tooltip-content">
                                                Distance above ground when fall begins (must be ≥ 0)
                                            </div>
                                        </div>
                                    </div>
                                    <input type="number" id="initialHeight" class="input-field" placeholder="e.g., 100">
                                    <p class="error-message" id="initialHeightError"></p>
                                </div>
                                
                                <div class="input-section" id="timeInputSection">
                                    <label class="input-label">Time to fall (t) <span class="text-gray-500 ml-1">(s)</span></label>
                                    <input type="number" id="timeResult" class="input-field" placeholder="e.g., 4.5">
                                    <p class="error-message" id="timeResultError"></p>
                                </div>
                                
                                <div class="input-section" id="velocityInputSection">
                                    <label class="input-label">Final velocity (v) <span class="text-gray-500 ml-1">(m/s)</span></label>
                                    <input type="number" id="velocityResult" class="input-field" placeholder="e.g., 44.3">
                                    <p class="error-message" id="velocityResultError"></p>
                                </div>
                                
                                <div class="input-group">
                                    <label class="input-label">Select what to calculate</label>
                                    <select id="calcTarget" class="input-field">
                                        <option value="all">All missing values</option>
                                        <option value="height">Initial Height</option>
                                        <option value="time">Time to fall</option>
                                        <option value="velocity">Final velocity</option>
                                    </select>
                                </div>
                                
                                <div id="inputHelper" class="input-helper">
                                    <i class="ri-lightbulb-line mr-2"></i> Enter at least one value to compute results
                                </div>
                                
                                <div class="button-group">
                                    <button id="calculateBtn" class="btn btn-primary">
                                        Calculate
                                    </button>
                                    <button id="resetAllBtn" class="btn btn-gray">
                                        Reset All
                                    </button>
                                </div>

                                <!-- Go to Simulation button container -->
                                <div id="goToSimulationContainer" class="go-to-simulation-container">
                                    <button id="goToSimulationBtn" class="btn btn-secondary">
                                        <i class="ri-arrow-down-line mr-2"></i>Go to Simulation
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Results Column -->
                            <div>
                                <div class="toggle-section mb-4">
                                    <div class="toggle-header" id="physicsEquationsToggle">
                                        <h3 class="section-title text-xl font-bold text-gray-800">Physics Equations</h3>
                                        <i class="ri-arrow-down-s-line toggle-icon"></i>
                                    </div>
                                    <div class="toggle-content expanded" id="physicsEquationsContent">
                                        <div class="space-y-3">
                                            <div class="equation-card">
                                                <p class="font-medium text-gray-700 mb-1">Height (Position):</p>
                                                <p class="equation">$$ h = h_0 + v_0 t + \frac{1}{2} g t^2 $$</p>
                                            </div>
                                            <div class="equation-card">
                                                <p class="font-medium text-gray-700 mb-1">Final Velocity (from Time):</p>
                                                <p class="equation">$$ v = v_0 + g t $$</p>
                                            </div>
                                            <div class="equation-card">
                                                <p class="font-medium text-gray-700 mb-1">Final Velocity (from Height):</p>
                                                <p class="equation">$$ v^2 = v_0^2 + 2 g (h - h_0) $$</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="toggle-section">
                                    <div class="toggle-header" id="solutionStepsToggle">
                                        <div class="flex justify-between items-center">
                                            <h4 class="font-bold text-gray-800">Solution Steps</h4>
                                        </div>
                                        <i class="ri-arrow-down-s-line toggle-icon"></i>
                                    </div>
                                    <div class="toggle-content expanded" id="solutionStepsContent">
                                        <div id="activeEquation" class="text-gray-700">
                                            Enter values and click "Calculate" to see solution steps
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="results-section">
                                    <div class="highlight-box hidden" id="resultSummary">
                                        <div class="results-heading">
                                            <i class="ri-file-list-2-line"></i>
                                            <h3 class="text-xl font-bold text-gray-800">Calculation Results</h3>
                                        </div>
                                        <div class="result-summary">
                                            <div class="result-card" id="heightCard">
                                                <div class="result-label">Initial Height</div>
                                                <div class="result-value" id="summaryHeight">0</div>
                                                <div class="result-unit">meters</div>
                                            </div>
                                            <div class="result-card" id="timeCard">
                                                <div class="result-label">Time to Fall</div>
                                                <div class="result-value" id="summaryTime">0</div>
                                                <div class="result-unit">seconds</div>
                                            </div>
                                            <div class="result-card" id="velocityCard">
                                                <div class="result-label">Final Velocity</div>
                                                <div class="result-value" id="summaryVelocity">0</div>
                                                <div class="result-unit">m/s</div>
                                            </div>
                                            <div class="result-card">
                                                <div class="result-label">Gravity</div>
                                                <div class="result-value" id="summaryGravity">0</div>
                                                <div class="result-unit">m/s²</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Dedicated Results Card -->
                                    <div id="calculationResultCard" class="calculation-card hidden">
                                        <div class="calculation-title">
                                            <i class="ri-calculator-line"></i>
                                            <span>Calculation Result</span>
                                        </div>
                                        <div id="resultTitle" class="text-gray-700 font-medium"></div>
                                        <div id="resultValue" class="calculation-result"></div>
                                        <div id="resultDetails" class="calculation-details"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Simulation Section -->
                    <div id="simulationSection" class="simulation-section mt-8">
                        <div class="simulation-header">
                            <div>
                                <h3 class="simulation-title">Free Fall Simulation</h3>
                                <p class="simulation-subtitle">Interactive visualization of the falling object</p>
                            </div>
                            <div class="simulation-info">
                                <div id="simStatus" class="text-sm flex items-center">
                                    <span class="status-indicator status-ready"></span>
                                    <span>Ready</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress-bar">
                            <div id="progressValue" class="progress-value" style="width: 0%"></div>
                        </div>
                        
                        <div class="simulation-container">
                            <!-- Ball data display -->
                            <div id="ballDataDisplay" class="ball-data-display">No data</div>
                            
                            <div id="simulationData" class="simulation-data hidden">
                                <div class="grid grid-cols-2 gap-1 text-xs">
                                    <span>Time:</span>
                                    <span id="dispTime">0.00 s</span>
                                    <span>Velocity:</span>
                                    <span id="dispVelocity">0.00 m/s</span>
                                    <span>Height:</span>
                                    <span id="dispHeight">0.00 m</span>
                                </div>
                            </div>
                            
                            <canvas id="simulationCanvas" width="100%" height="400"></canvas>
                            
                            <!-- Vertical sliders on the right -->
                            <div class="slider-container">
                                <div class="slider-group">
                                    <div class="slider-label">Position</div>
                                    <input type="range" orient="vertical" id="scrubber" class="simulation-slider vertical" min="0" max="1000" value="0">
                                    <div class="slider-value-display" id="sliderPositionValue">0%</div>
                                </div>
                                
                                <div class="slider-group">
                                    <div class="slider-label">Speed</div>
                                    <input type="range" orient="vertical" id="playbackSpeed" class="simulation-slider vertical" min="0.25" max="2" step="0.25" value="1">
                                    <div class="slider-value-display" id="sliderSpeedValue">1x</div>
                                </div>
                            </div>
                            
                            <!-- Control buttons at bottom-left -->
                            <div class="simulation-buttons">
                                <button id="pauseResumeBtn" class="sim-btn" title="Pause/Resume">
                                    <i class="ri-pause-line" id="pauseBtnIcon"></i>
                                </button>
                                <button id="replayBtn" class="sim-btn" title="Restart">
                                    <i class="ri-restart-line"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Simulate button below simulation box -->
                        <div class="w-full flex justify-center mt-6 mb-4">
                            <button id="simulateBtn" class="btn btn-secondary w-40 text-center relative" disabled>
                                <i class="ri-play-line mr-2"></i>Simulate
                                <div class="tooltip-content absolute bottom-full left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs p-2 rounded whitespace-nowrap opacity-0 transition-opacity pointer-events-none">
                                    Calculate parameters first to simulate
                                </div>
                            </button>
                        </div>
                        
                        <div class="simulation-controls mt-4 bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm text-gray-600">
                                <p class="flex items-center mb-1"><i class="ri-drag-move-2-line mr-2"></i> Drag position slider to scrub through timeline</p>
                                <p class="flex items-center"><i class="ri-speed-line mr-2"></i> Adjust speed slider to control simulation speed</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Free Fall Concept Section -->
        <section id="concept" class="compact-section bg-white">
            <div class="container mx-auto px-4">
                <div class="compact-card">
                    <div class="flex items-center mb-6">
                        <i class="ri-lightbulb-line text-accent text-2xl mr-3"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Understanding Free Fall</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <p>Free fall is a fundamental concept in physics where an object moves under the influence of gravitational force only. In free fall, air resistance is negligible, and all objects accelerate at the same rate regardless of their mass.</p>
                        
                        <div>
                            <h3 class="font-bold text-lg mb-2">Key Principles</h3>
                            <ul class="space-y-2 ml-5 list-disc">
                                <li><strong>Acceleration due to gravity (g)</strong>: Constant downward acceleration (9.8 m/s² on Earth)</li>
                                <li><strong>Initial velocity (v₀)</strong>: The object's starting velocity (can be zero or non-zero)</li>
                                <li><strong>Displacement (h)</strong>: The vertical distance an object falls (h = 0 - h₀)</li>
                                <li><strong>Time of flight (t)</strong>: Duration from release to impact</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h3 class="font-bold text-lg mb-2">Equations of Motion</h3>
                            <div class="equation-card">
                                <p class="equation">
                                    <strong>Position:</strong> $$ h = h_0 + v_0 t + \frac{1}{2} g t^2 $$<br>
                                    <strong>Velocity:</strong> $$ v = v_0 + g t $$<br>
                                    <strong>Velocity from height:</strong> $$ v^2 = v_0^2 + 2 g (h - h_0) $$
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white compact-footer">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-300">© 2023 Free Fall Physics Calculator | Educational Tool</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Global variables to track original inputs and exact values
            let originalHeight = NaN;
            let originalTime = NaN;
            let originalVelocity = NaN;
            let exactHeight = 0;
            let exactTime = 0;
            let exactVelocity = 0;
            let knownValues = { height: false, time: false, velocity: false };
            let calculatedTarget = '';
            let lastSpeedValue = 1.0;
            let cloudPositions = [];
            let hasSimulated = false;
            
            // Calculator variables
            const gravitySelect = document.getElementById('gravitySelect');
            const customGravityContainer = document.getElementById('customGravityContainer');
            const customGravity = document.getElementById('customGravity');
            const initialHeightInput = document.getElementById('initialHeight');
            const initialVelocityInput = document.getElementById('initialVelocity');
            const calculateBtn = document.getElementById('calculateBtn');
            const simulateBtn = document.getElementById('simulateBtn');
            const pauseResumeBtn = document.getElementById('pauseResumeBtn');
            const pauseBtnIcon = document.getElementById('pauseBtnIcon');
            const replayBtn = document.getElementById('replayBtn');
            const resetAllBtn = document.getElementById('resetAllBtn');
            const timeResultInput = document.getElementById('timeResult');
            const velocityResultInput = document.getElementById('velocityResult');
            const calcTarget = document.getElementById("calcTarget");
            const activeEquation = document.getElementById("activeEquation");
            const progressValue = document.getElementById("progressValue");
            const simStatus = document.getElementById("simStatus");
            const resultSummary = document.getElementById("resultSummary");
            const summaryHeight = document.getElementById("summaryHeight");
            const summaryTime = document.getElementById("summaryTime");
            const summaryVelocity = document.getElementById("summaryVelocity");
            const summaryGravity = document.getElementById("summaryGravity");
            const heightCard = document.getElementById("heightCard");
            const timeCard = document.getElementById("timeCard");
            const velocityCard = document.getElementById("velocityCard");
            const scrubber = document.getElementById("scrubber");
            const playbackSpeed = document.getElementById("playbackSpeed");
            const sliderPositionValue = document.getElementById("sliderPositionValue");
            const sliderSpeedValue = document.getElementById("sliderSpeedValue");
            const heightInputSection = document.getElementById("heightInputSection");
            const timeInputSection = document.getElementById("timeInputSection");
            const velocityInputSection = document.getElementById("velocityInputSection");
            const calculationResultCard = document.getElementById("calculationResultCard");
            const resultTitle = document.getElementById("resultTitle");
            const resultValue = document.getElementById("resultValue");
            const resultDetails = document.getElementById("resultDetails");
            const ballDataDisplay = document.getElementById("ballDataDisplay");
            const goToSimulationBtn = document.getElementById('goToSimulationBtn');
            const inputHelper = document.getElementById('inputHelper');
            const inputs = [initialHeightInput, timeResultInput, velocityResultInput];
            const physicsEquationsToggle = document.getElementById('physicsEquationsToggle');
            const physicsEquationsContent = document.getElementById('physicsEquationsContent');
            const solutionStepsToggle = document.getElementById('solutionStepsToggle');
            const solutionStepsContent = document.getElementById('solutionStepsContent');

            // Simulation variables
            const simulationCanvas = document.getElementById('simulationCanvas');
            const ctx = simulationCanvas.getContext('2d');
            
            let sim_gravity = 9.8;
            let sim_initial_height = 0;
            let sim_current_height = 0;
            let sim_initial_v = 0;
            let sim_time_elapsed = 0;
            let animationId = null;
            let isSimulating = false;
            let isPaused = false;
            let lastTimestamp = 0;
            let simulationActive = false;
            let simulationEnded = false;
            let totalTime = 0;
            let simulationSpeed = 1.0;
            let cloudAnimationId = null;
            
            // Set canvas dimensions
            function resizeCanvas() {
                const container = simulationCanvas.parentElement;
                simulationCanvas.width = container.clientWidth;
                simulationCanvas.height = container.clientHeight;
                drawSimulation();
            }
            
            // Draw the simulation
            function drawSimulation() {
                const canvas = simulationCanvas;
                const groundLevel = canvas.height - 20;
                const objectSize = 16;
                
                const totalFallHeight = sim_initial_height;
                let displayHeight = sim_current_height;

                if (displayHeight < 0) displayHeight = 0;

                let currentY;
                if (totalFallHeight > 0) {
                     currentY = groundLevel - (displayHeight / totalFallHeight) * (groundLevel - (objectSize / 2 + 10));
                } else {
                    currentY = groundLevel - (objectSize / 2);
                }
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw sky gradient
                const skyGradient = ctx.createLinearGradient(0, 0, 0, groundLevel);
                skyGradient.addColorStop(0, "#87CEEB");
                skyGradient.addColorStop(1, "#E0F7FA");
                ctx.fillStyle = skyGradient;
                ctx.fillRect(0, 0, canvas.width, groundLevel);
                
                // Draw clouds
                if (cloudPositions.length > 0) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    cloudPositions.forEach(cloud => {
                        ctx.beginPath();
                        ctx.arc(cloud.x, cloud.y, cloud.size, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(cloud.x + cloud.size*0.8, cloud.y - cloud.size*0.2, cloud.size*0.7, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(cloud.x - cloud.size*0.8, cloud.y, cloud.size*0.6, 0, Math.PI * 2);
                        ctx.fill();
                    });
                }
                
                // Draw platform
                const platformWidth = 80;
                const platformHeight = 10;
                const platformX = canvas.width / 2 - platformWidth / 2;
                const platformY = groundLevel - (sim_initial_height / totalFallHeight) * (groundLevel - (objectSize / 2 + 10)) - platformHeight;
                
                ctx.fillStyle = '#8d6e63';
                ctx.fillRect(platformX, platformY, platformWidth, platformHeight);
                
                // Add platform shadow
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fillRect(platformX, platformY + platformHeight, platformWidth, 4);
                
                // Draw ground
                ctx.fillStyle = '#00796b';
                ctx.fillRect(0, groundLevel, canvas.width, canvas.height - groundLevel);
                
                // Draw ground texture
                ctx.fillStyle = '#004d40';
                for (let i = 0; i < canvas.width; i += 15) {
                    ctx.fillRect(i, groundLevel, 10, 3);
                }
                
                // Draw object with shadow
                ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetY = 2;

                // Create radial gradient for 3D effect
                const gradient = ctx.createRadialGradient(
                    canvas.width / 2 - 4, 
                    currentY - 4, 
                    2,
                    canvas.width / 2, 
                    currentY, 
                    objectSize
                );
                gradient.addColorStop(0, '#ff6f5e'); // Light red
                gradient.addColorStop(1, '#d32f2f');  // Dark red

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(canvas.width / 2, currentY, objectSize, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#e53935';
                ctx.beginPath();
                ctx.arc(canvas.width / 2, currentY, objectSize, 0, Math.PI * 2);
                ctx.fill();

                // Add highlight for shine effect
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.beginPath();
                ctx.arc(
                    canvas.width / 2 - objectSize/3, 
                    currentY - objectSize/3, 
                    objectSize/3, 
                    0, 
                    Math.PI * 2
                );
                ctx.fill();
                
                // Reset shadow
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetY = 0;
                
                // Draw trail if falling
                if (sim_current_height < sim_initial_height && sim_current_height > 0) {
                    ctx.beginPath();
                    ctx.moveTo(canvas.width / 2, platformY + platformHeight/2);
                    ctx.lineTo(canvas.width / 2, currentY);
                    ctx.strokeStyle = 'rgba(229, 57, 53, 0.4)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                // Update ball data display
                updateBallDataDisplay(canvas.width / 2, currentY);
            }
            
            // Generate initial clouds
            function generateClouds() {
                const canvas = simulationCanvas;
                cloudPositions = [];
                const cloudCount = 5;
                
                for (let i = 0; i < cloudCount; i++) {
                    cloudPositions.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * (canvas.height * 0.4),
                        size: 15 + Math.random() * 20,
                        speed: 0.1 + Math.random() * 0.3
                    });
                }
            }
            
            // Animate clouds
            function animateClouds() {
                const canvas = simulationCanvas;
                
                cloudPositions.forEach(cloud => {
                    cloud.x += cloud.speed;
                    if (cloud.x > canvas.width + 50) {
                        cloud.x = -50;
                        cloud.y = Math.random() * (canvas.height * 0.4);
                    }
                });
                
                drawSimulation();
                cloudAnimationId = requestAnimationFrame(animateClouds);
            }
            
            // Update ball data display
            function updateBallDataDisplay(ballX, ballY) {
                if (!simulationActive) {
                    ballDataDisplay.style.display = 'none';
                    return;
                }
                
                let content = '';
                let showDisplay = false;
                
                // Always show gravity as it's always known
                content += `<div>Acceleration due to gravity: ${sim_gravity.toFixed(2)} m/s²</div>`;
                showDisplay = true;
                
                // Show height if it was provided or calculated
                if (knownValues.height || calculatedTarget === 'height' || calculatedTarget === 'all') {
                    content += `<div>Initial Height: ${sim_initial_height.toFixed(2)} m</div>`;
                    content += `<div>Current Height: ${sim_current_height.toFixed(2)} m</div>`;
                    showDisplay = true;
                }
                
                // Show time if it was provided or calculated
                if (knownValues.time || calculatedTarget === 'time' || calculatedTarget === 'all') {
                    content += `<div>Time: ${sim_time_elapsed.toFixed(2)} s</div>`;
                    showDisplay = true;
                }
                
                // Show velocity if it was provided or calculated
                if (knownValues.velocity || calculatedTarget === 'velocity' || calculatedTarget === 'all') {
                    const currentVelocity = sim_initial_v + (sim_gravity * sim_time_elapsed);
                    content += `<div>Velocity: ${currentVelocity.toFixed(2)} m/s</div>`;
                    showDisplay = true;
                }
                
                if (showDisplay) {
                    ballDataDisplay.innerHTML = content;
                    ballDataDisplay.style.display = 'block';
                    
                    // Position display near the ball
                    const displayWidth = ballDataDisplay.offsetWidth;
                    const displayHeight = ballDataDisplay.offsetHeight;
                    
                    let left = ballX + 25;
                    let top = ballY - displayHeight / 2;
                    
                    // Adjust position to avoid going off screen
                    const container = simulationCanvas.parentElement;
                    if (left + displayWidth > container.clientWidth) {
                        left = ballX - displayWidth - 25;
                    }
                    
                    if (top < 0) {
                        top = 10;
                    } else if (top + displayHeight > container.clientHeight) {
                        top = container.clientHeight - displayHeight - 10;
                    }
                    
                    ballDataDisplay.style.left = `${left}px`;
                    ballDataDisplay.style.top = `${top}px`;
                } else {
                    ballDataDisplay.style.display = 'none';
                }
            }
            
            // Update the active equation display
            function updateActiveEquation() {
                const g = getGravityValue();
                const vi = parseFloat(initialVelocityInput.value) || 0;
                const target = calcTarget.value;
                
                let equationText = "Enter values and click 'Calculate' to see solution steps";
                
                // Check which equation is being used based on what we're calculating
                if (target === "height") {
                    const t = parseFloat(timeResultInput.value);
                    const v = parseFloat(velocityResultInput.value);
                    
                    if (!isNaN(t)) {
                        equationText = `<strong>Calculating Initial Height:</strong><br>`; 
                        equationText += `Formula: $$ h = v_0 t + \\frac{1}{2} g t^2 $$<br>`; 
                        equationText += `Calculation: $$ h = (${vi}) \\times (${t}) + \\frac{1}{2} \\times (${g}) \\times (${t})^2 $$<br>`; 
                        equationText += `Step 1: $$ v_0 t = ${vi} \\times ${t} = ${(vi*t).toFixed(2)} $$<br>`; 
                        equationText += `Step 2: $$ \\frac{1}{2} g t^2 = \\frac{1}{2} \\times ${g} \\times ${(t*t).toFixed(2)} = ${(0.5*g*t*t).toFixed(2)} $$<br>`; 
                        equationText += `Step 3: $$ h = ${(vi*t).toFixed(2)} + ${(0.5*g*t*t).toFixed(2)} $$`; 
                    } else if (!isNaN(v)) {
                        equationText = `<strong>Calculating Initial Height:</strong><br>`; 
                        equationText += `Formula: $$ h = \\frac{v^2 - v_0^2}{2g} $$<br>`; 
                        equationText += `Calculation: $$ h = \\frac{${v}^2 - ${vi}^2}{2 \\times ${g}} $$<br>`; 
                        equationText += `Step 1: $$ v^2 = ${v} \\times ${v} = ${(v*v).toFixed(2)} $$<br>`; 
                        equationText += `Step 2: $$ v_0^2 = ${vi} \\times ${vi} = ${(vi*vi).toFixed(2)} $$<br>`; 
                        equationText += `Step 3: $$ v^2 - v_0^2 = ${(v*v).toFixed(2)} - ${(vi*vi).toFixed(2)} = ${(v*v - vi*vi).toFixed(2)} $$<br>`; 
                        equationText += `Step 4: $$ 2g = 2 \\times ${g} = ${(2 * g).toFixed(2)} $$<br>`; 
                        equationText += `Step 5: $$ h = \\frac{${(v*v - vi*vi).toFixed(2)}}{${(2 * g).toFixed(2)}} $$`; 
                    } else {
                        equationText = "Please provide either Time or Final Velocity to calculate Initial Height.";
                    }
                }
                else if (target === "time") {
                    const h = parseFloat(initialHeightInput.value);
                    const v = parseFloat(velocityResultInput.value);
                    
                    if (!isNaN(h)) {
                        const discriminant = vi*vi + 2*g*h;
                        if (discriminant >= 0) {
                            const sqrtDiscriminant = Math.sqrt(discriminant);
                            equationText = `<strong>Calculating Time:</strong><br>`; 
                            equationText += `Formula: $$ v^2 = v_0^2 + 2 g h $$<br>`; 
                            equationText += `Solving quadratic equation: $$ t = \\frac{ -v_0 + \\sqrt{v_0^2 + 2 g h} }{g} $$<br>`; 
                            equationText += `Step 1: $$ v_0^2 = ${vi} \\times ${vi} = ${(vi*vi).toFixed(2)} $$<br>`; 
                            equationText += `Step 2: $$ 2 g h = 2 \\times ${g} \\times ${h} = ${(2*g*h).toFixed(2)} $$<br>`; 
                            equationText += `Step 3: $$ v_0^2 + 2 g h = ${(vi*vi).toFixed(2)} + ${(2*g*h).toFixed(2)} = ${discriminant.toFixed(2)} $$<br>`; 
                            equationText += `Step 4: $$ \\sqrt{v_0^2 + 2 g h} = \\sqrt{${discriminant.toFixed(2)}} = ${sqrtDiscriminant.toFixed(2)} $$<br>`; 
                            equationText += `Step 5: $$ t = \\frac{ -${vi} + ${sqrtDiscriminant.toFixed(2)} }{${g}} $$`; 
                        } else {
                            equationText = "No real solution for time with the given height and initial velocity.";
                        }
                    } else if (!isNaN(v)) {
                        equationText = `<strong>Calculating Time:</strong><br>`; 
                        equationText += `Formula: $$ t = \\frac{v - v_0}{g} $$<br>`; 
                        equationText += `Calculation: $$ t = \\frac{${v} - ${vi}}{${g}} $$<br>`; 
                        equationText += `Step 1: $$ v - v_0 = ${v} - ${vi} = ${(v - vi).toFixed(2)} $$<br>`; 
                        equationText += `Step 2: $$ t = \\frac{${(v - vi).toFixed(2)}}{${g}} $$`; 
                    } else {
                        equationText = "Please provide 'Initial Height' or 'Final Velocity' to calculate 'Time to fall'.";
                    }
                }
                else if (target === "velocity") {
                    const t = parseFloat(timeResultInput.value);
                    const h = parseFloat(initialHeightInput.value);
                    
                    if (!isNaN(t)) {
                        equationText = `<strong>Calculating Final Velocity (from time):</strong><br>`; 
                        equationText += `Formula: $$ v = v_0 + g t $$<br>`; 
                        equationText += `Calculation: $$ v = ${vi} + (${g}) \\times (${t}) $$<br>`; 
                        equationText += `Step 1: $$ g t = ${g} \\times ${t} = ${(g*t).toFixed(2)} $$<br>`; 
                        equationText += `Step 2: $$ v = ${vi} + ${(g*t).toFixed(2)} $$`; 
                    } else if (!isNaN(h)) {
                        equationText = `<strong>Calculating Final Velocity (from height):</strong><br>`; 
                        equationText += `Formula: $$ v^2 = v_0^2 + 2 g h $$<br>`; 
                        equationText += `Calculation: $$ v = \\sqrt{${vi}^2 + 2 \\times ${g} \\times ${h}} $$<br>`; 
                        equationText += `Step 1: $$ v_0^2 = ${vi} \\times ${vi} = ${(vi*vi).toFixed(2)} $$<br>`; 
                        equationText += `Step 2: $$ 2 g h = 2 \\times ${g} \\times ${h} = ${(2*g*h).toFixed(2)} $$<br>`; 
                        equationText += `Step 3: $$ v_0^2 + 2 g h = ${(vi*vi).toFixed(2)} + ${(2*g*h).toFixed(2)} = ${(vi*vi + 2*g*h).toFixed(2)} $$<br>`; 
                        equationText += `Step 4: $$ v = \\sqrt{${(vi*vi + 2*g*h).toFixed(2)}} $$`;
                    }
                }
                else if (target === "all") {
                    equationText = "<strong>Solving for all missing values:</strong><br>";
                    
                    // Solve for height if missing
                    if (isNaN(originalHeight)) {
                        if (!isNaN(originalTime)) {
                            equationText += `<strong>Initial Height Calculation:</strong><br>`;
                            equationText += `Formula: $$ h = v_0 t + \\frac{1}{2} g t^2 $$<br>`;
                            equationText += `Calculation: $$ h = (${vi}) \\times (${originalTime}) + \\frac{1}{2} \\times (${g}) \\times (${originalTime})^2 $$<br>`;
                            equationText += `Step 1: $$ v_0 t = ${vi} \\times ${originalTime} = ${(vi * originalTime).toFixed(2)} $$<br>`;
                            equationText += `Step 2: $$ \\frac{1}{2} g t^2 = \\frac{1}{2} \\times ${g} \\times ${(originalTime * originalTime).toFixed(2)} = ${(0.5 * g * originalTime * originalTime).toFixed(2)} $$<br>`;
                            equationText += `Step 3: $$ h = ${(vi * originalTime).toFixed(2)} + ${(0.5 * g * originalTime * originalTime).toFixed(2)} $$<br><br>`;
                        } else if (!isNaN(originalVelocity)) {
                            equationText += `<strong>Initial Height Calculation:</strong><br>`;
                            equationText += `Formula: $$ h = \\frac{v^2 - v_0^2}{2g} $$<br>`;
                            equationText += `Calculation: $$ h = \\frac{${originalVelocity}^2 - ${vi}^2}{2 \\times ${g}} $$<br>`;
                            equationText += `Step 1: $$ v^2 = ${originalVelocity} \\times ${originalVelocity} = ${(originalVelocity * originalVelocity).toFixed(2)} $$<br>`;
                            equationText += `Step 2: $$ v_0^2 = ${vi} \\times ${vi} = ${(vi * vi).toFixed(2)} $$<br>`;
                            equationText += `Step 3: $$ v^2 - v_0^2 = ${(originalVelocity * originalVelocity).toFixed(2)} - ${(vi * vi).toFixed(2)} = ${(originalVelocity * originalVelocity - vi * vi).toFixed(2)} $$<br>`;
                            equationText += `Step 4: $$ 2g = 2 \\times ${g} = ${(2 * g).toFixed(2)} $$<br>`;
                            equationText += `Step 5: $$ h = \\frac{${(originalVelocity * originalVelocity - vi * vi).toFixed(2)}}{${(2 * g).toFixed(2)}} $$<br><br>`;
                        }
                    }

                    // Solve for time if missing
                    if (isNaN(originalTime)) {
                        if (!isNaN(originalHeight)) {
                            const discriminant = vi * vi + 2 * g * originalHeight;
                            if (discriminant >= 0) {
                                const sqrtDiscriminant = Math.sqrt(discriminant);
                                equationText += `<strong>Time Calculation:</strong><br>`;
                                equationText += `Formula: $$ t = \\frac{ -v_0 + \\sqrt{v_0^2 + 2 g h} }{g} $$<br>`;
                                equationText += `Calculation: $$ t = \\frac{ -${vi} + \\sqrt{${vi}^2 + 2 \\times ${g} \\times ${originalHeight}} }{${g}} $$<br>`;
                                equationText += `Step 1: $$ v_0^2 = ${vi} \\times ${vi} = ${(vi * vi).toFixed(2)} $$<br>`;
                                equationText += `Step 2: $$ 2 g h = 2 \\times ${g} \\times ${originalHeight} = ${(2 * g * originalHeight).toFixed(2)} $$<br>`;
                                equationText += `Step 3: $$ v_0^2 + 2 g h = ${(vi * vi).toFixed(2)} + ${(2 * g * originalHeight).toFixed(2)} = ${discriminant.toFixed(2)} $$<br>`;
                                equationText += `Step 4: $$ \\sqrt{v_0^2 + 2 g h} = \\sqrt{${discriminant.toFixed(2)}} = ${sqrtDiscriminant.toFixed(2)} $$<br>`;
                                equationText += `Step 5: $$ t = \\frac{ -${vi} + ${sqrtDiscriminant.toFixed(2)} }{${g}} $$<br><br>`;
                            }
                        } else if (!isNaN(originalVelocity)) {
                            equationText += `<strong>Time Calculation:</strong><br>`;
                            equationText += `Formula: $$ t = \\frac{v - v_0}{g} $$<br>`;
                            equationText += `Calculation: $$ t = \\frac{${originalVelocity} - ${vi}}{${g}} $$<br>`;
                            equationText += `Step 1: $$ v - v_0 = ${originalVelocity} - ${vi} = ${(originalVelocity - vi).toFixed(2)} $$<br>`;
                            equationText += `Step 2: $$ t = \\frac{${(originalVelocity - vi).toFixed(2)}}{${g}} $$<br><br>`;
                        }
                    }

                    // Solve for velocity if missing
                    if (isNaN(originalVelocity)) {
                        if (!isNaN(originalTime)) {
                            equationText += `<strong>Final Velocity Calculation:</strong><br>`;
                            equationText += `Formula: $$ v = v_0 + g t $$<br>`;
                            equationText += `Calculation: $$ v = ${vi} + (${g}) \\times (${originalTime}) $$<br>`;
                            equationText += `Step 1: $$ g t = ${g} \\times ${originalTime} = ${(g * originalTime).toFixed(2)} $$<br>`;
                            equationText += `Step 2: $$ v = ${vi} + ${(g * originalTime).toFixed(2)} $$`;
                        } else if (!isNaN(originalHeight)) {
                            equationText += `<strong>Final Velocity Calculation:</strong><br>`;
                            equationText += `Formula: $$ v^2 = v_0^2 + 2 g h $$<br>`;
                            equationText += `Calculation: $$ v = \\sqrt{${vi}^2 + 2 \\times ${g} \\times ${originalHeight}} $$<br>`;
                            equationText += `Step 1: $$ v_0^2 = ${vi} \\times ${vi} = ${(vi * vi).toFixed(2)} $$<br>`;
                            equationText += `Step 2: $$ 2 g h = 2 \\times ${g} \\times ${originalHeight} = ${(2 * g * originalHeight).toFixed(2)} $$<br>`;
                            equationText += `Step 3: $$ v_0^2 + 2 g h = ${(vi * vi).toFixed(2)} + ${(2 * g * originalHeight).toFixed(2)} = ${(vi * vi + 2 * g * originalHeight).toFixed(2)} $$<br>`;
                            equationText += `Step 4: $$ v = \\sqrt{${(vi * vi + 2 * g * originalHeight).toFixed(2)}} $$`;
                        }
                    }
                }
                
                activeEquation.innerHTML = equationText;
                MathJax.typeset();
            }
            
            function calculateFreeFall() {
                // Validate inputs first
                if (!validateInputs()) {
                    return;
                }
                
                // Store original input values
                originalHeight = parseFloat(initialHeightInput.value) || NaN;
                originalTime = parseFloat(timeResultInput.value) || NaN;
                originalVelocity = parseFloat(velocityResultInput.value) || NaN;
                
                const g = getGravityValue();
                const vi = parseFloat(initialVelocityInput.value) || 0;

                simulateBtn.disabled = false;
                hasSimulated = false; // Reset simulation flag
                resultSummary.classList.add('hidden');
                calculationResultCard.classList.add('hidden');

                let inputsProvided = [];
                if (!isNaN(originalHeight) && originalHeight >= 0) inputsProvided.push({ type: 'height', value: originalHeight });
                if (!isNaN(originalTime) && originalTime >= 0) inputsProvided.push({ type: 'time', value: originalTime });
                if (!isNaN(originalVelocity)) inputsProvided.push({ type: 'velocity', value: originalVelocity });

                let calculationSuccessful = false;
                const target = calcTarget.value;
                calculatedTarget = target; // Store what we're calculating

                if (inputsProvided.length === 0) {
                    showError('initialHeight', "Please provide at least one valid value");
                    resetSimulation();
                    return;
                }

                // Initialize exact values
                exactHeight = originalHeight;
                exactTime = originalTime;
                exactVelocity = originalVelocity;

                // Track known values
                knownValues = {
                    height: !isNaN(parseFloat(initialHeightInput.value)),
                    time: !isNaN(parseFloat(timeResultInput.value)),
                    velocity: !isNaN(parseFloat(velocityResultInput.value))
                };

                // Single input scenario
                if (inputsProvided.length === 1 || (target === 'all' && inputsProvided.length === 1)) {
                    const provided = inputsProvided[0];

                    if (provided.type === 'height') {
                        const a = 0.5 * g;
                        const b = vi;
                        const c = -provided.value;
                        const discriminant = b * b - 4 * a * c;

                        if (discriminant >= 0) {
                            const t1 = (-b + Math.sqrt(discriminant)) / (2 * a);
                            const t2 = (-b - Math.sqrt(discriminant)) / (2 * a);
                            const t_calc = Math.max(t1, t2);
                            if (t_calc >= 0) {
                                exactHeight = provided.value;
                                exactTime = t_calc;
                                exactVelocity = vi + g * t_calc;
                                calculationSuccessful = true;
                            } else {
                                showError('initialHeight', "Calculated time is negative for the provided height");
                            }
                        } else {
                            showError('initialHeight', "No real solution for time with the given height");
                        }
                    } else if (provided.type === 'time') {
                        exactHeight = vi * provided.value + 0.5 * g * provided.value * provided.value;
                        exactTime = provided.value;
                        exactVelocity = vi + g * provided.value;
                        calculationSuccessful = true;
                    } else if (provided.type === 'velocity') {
                        if (g > 0 && provided.value < vi && vi >= 0) {
                             showError('velocityResult', "Final velocity must be ≥ initial velocity");
                             resetSimulation();
                             return;
                        }
                        const t_calc = (provided.value - vi) / g;
                        if (t_calc >= 0) {
                            exactHeight = vi * t_calc + 0.5 * g * t_calc * t_calc;
                            exactTime = t_calc;
                            exactVelocity = provided.value;
                            calculationSuccessful = true;
                        } else {
                            showError('velocityResult', "Calculated time is negative for the provided velocity");
                        }
                    }
                } else {
                    // Multiple inputs provided
                    if (target === 'all') {
                        if (!isNaN(originalHeight) && !isNaN(originalTime) && originalHeight >= 0 && originalTime >= 0) {
                            exactVelocity = vi + g * originalTime;
                            exactHeight = originalHeight;
                            exactTime = originalTime;
                            calculationSuccessful = true;
                        } else if (!isNaN(originalHeight) && !isNaN(originalVelocity) && originalHeight >= 0) {
                            if (g > 0 && originalVelocity < vi && vi >= 0) {
                                showError('velocityResult', "Final velocity must be ≥ initial velocity");
                                resetSimulation();
                                return;
                            }
                            exactTime = (originalVelocity - vi) / g;
                            exactHeight = originalHeight;
                            exactVelocity = originalVelocity;
                            calculationSuccessful = true;
                        } else if (!isNaN(originalTime) && !isNaN(originalVelocity) && originalTime >= 0) {
                            exactHeight = (originalVelocity - g * originalTime) * originalTime + 0.5 * g * originalTime * originalTime;
                            exactTime = originalTime;
                            exactVelocity = originalVelocity;
                            calculationSuccessful = true;
                        } else {
                            showError('initialHeight', "Insufficient valid inputs for calculation");
                        }
                    } else if (target === 'height') {
                        if (!isNaN(originalTime) && originalTime >= 0) {
                            exactHeight = vi * originalTime + 0.5 * g * originalTime * originalTime;
                            calculationSuccessful = true;
                        } else if (!isNaN(originalVelocity)) {
                            exactHeight = (originalVelocity * originalVelocity - vi * vi) / (2 * g);
                            calculationSuccessful = true;
                        } else {
                            showError('timeResult', "Please provide time or velocity");
                        }
                    } else if (target === 'time') {
                        if (!isNaN(originalHeight) && originalHeight >= 0) {
                            const a = 0.5 * g;
                            const b = vi;
                            const c = -originalHeight;
                            const discriminant = b * b - 4 * a * c;

                            if (discriminant >= 0) {
                                const t1 = (-b + Math.sqrt(discriminant)) / (2 * a);
                                const t2 = (-b - Math.sqrt(discriminant)) / (2 * a);
                                exactTime = Math.max(t1, t2);
                                calculationSuccessful = true;
                            } else {
                                showError('initialHeight', "No real solution for time");
                            }
                        } else if (!isNaN(originalVelocity)) {
                            exactTime = (originalVelocity - vi) / g;
                            calculationSuccessful = true;
                        } else {
                            showError('initialHeight', "Please provide height or velocity");
                        }
                    } else if (target === 'velocity') {
                        if (!isNaN(originalTime) && originalTime >= 0) {
                            exactVelocity = vi + g * originalTime;
                            calculationSuccessful = true;
                        } else if (!isNaN(originalHeight) && originalHeight >= 0) {
                            exactVelocity = Math.sqrt(vi * vi + 2 * g * originalHeight);
                            calculationSuccessful = true;
                        } else {
                            showError('timeResult', "Please provide time or height");
                        }
                    }
                }

                // Update UI with results
                if (calculationSuccessful) {
                    // For 'all' target, hide the dedicated card and show the summary
                    if (target === 'all') {
                        resultSummary.classList.remove('hidden');
                        calculationResultCard.classList.add('hidden');
                    } else {
                        // Show dedicated results card
                        calculationResultCard.classList.remove('hidden');
                        resultSummary.classList.add('hidden');
                        
                        // Update the dedicated results card based on the target
                        if (target === 'height') {
                            resultTitle.textContent = "Initial Height Calculated";
                            resultValue.innerHTML = `<span class="highlight-text">${exactHeight.toFixed(2)} meters</span>`;
                            resultDetails.textContent = `Based on gravity: ${g.toFixed(2)} m/s² and provided parameters`;
                        } else if (target === 'time') {
                            resultTitle.textContent = "Time to Fall Calculated";
                            resultValue.innerHTML = `<span class="highlight-text">${exactTime.toFixed(2)} seconds</span>`;
                            resultDetails.textContent = `Based on gravity: ${g.toFixed(2)} m/s² and provided parameters`;
                        } else if (target === 'velocity') {
                            resultTitle.textContent = "Final Velocity Calculated";
                            resultValue.innerHTML = `<span class="highlight-text">${exactVelocity.toFixed(2)} m/s</span>`;
                            resultDetails.textContent = `Based on gravity: ${g.toFixed(2)} m/s² and provided parameters`;
                        }
                    }
                    
                    // Update result summary
                    summaryHeight.textContent = exactHeight.toFixed(2);
                    summaryTime.textContent = exactTime.toFixed(2);
                    summaryVelocity.textContent = exactVelocity.toFixed(2);
                    summaryGravity.textContent = g.toFixed(2);
                    
                    // Highlight the calculated results
                    if (target === 'height' || (target === 'all' && isNaN(originalHeight))) {
                        heightCard.classList.add('highlight-animation');
                        setTimeout(() => heightCard.classList.remove('highlight-animation'), 1000);
                    }
                    if (target === 'time' || (target === 'all' && isNaN(originalTime))) {
                        timeCard.classList.add('highlight-animation');
                        setTimeout(() => timeCard.classList.remove('highlight-animation'), 1000);
                    }
                    if (target === 'velocity' || (target === 'all' && isNaN(originalVelocity))) {
                        velocityCard.classList.add('highlight-animation');
                        setTimeout(() => velocityCard.classList.remove('highlight-animation'), 1000);
                    }
                    
                    // Add persistent highlight for calculated values when selecting "all"
                    if (target === 'all') {
                        // Remove existing calculated classes
                        heightCard.classList.remove('calculated');
                        timeCard.classList.remove('calculated');
                        velocityCard.classList.remove('calculated');
                        
                        // Add calculated class to the cards that were calculated (i.e., not provided originally)
                        if (isNaN(originalHeight)) {
                            heightCard.classList.add('calculated');
                        }
                        if (isNaN(originalTime)) {
                            timeCard.classList.add('calculated');
                        }
                        if (isNaN(originalVelocity)) {
                            velocityCard.classList.add('calculated');
                        }
                    }
                    
                    // Highlight the dedicated result card
                    if (target !== 'all') {
                        calculationResultCard.classList.add('highlight-animation');
                        setTimeout(() => calculationResultCard.classList.remove('highlight-animation'), 1000);
                    }
                    
                    // Scroll to results section smoothly
                    setTimeout(() => {
                        document.querySelector('.results-section').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 100);
                }

                // Enable simulation if possible
                if (!isNaN(exactHeight) && exactHeight > 0 && !isNaN(exactTime) && exactTime >= 0) {
                    simulateBtn.disabled = false;
                    sim_gravity = g;
                    sim_initial_height = exactHeight;
                    sim_initial_v = vi;
                    totalTime = exactTime;
                    
                    resetSimulation();
                } else {
                    simulateBtn.disabled = true;
                    resetSimulation();
                }
                
                // Update the active equation display
                updateActiveEquation();
                // Update input fields based on target
                updateInputFieldsBasedOnTarget();
            }
            
            // Get gravity value based on selection
            function getGravityValue() {
                if (gravitySelect.value === 'custom') {
                    const customG = parseFloat(customGravity.value);
                    if (isNaN(customG) || customG <= 0) {
                        return 9.8;
                    }
                    return customG;
                }
                return parseFloat(gravitySelect.value);
            }
            
            function resetAllFields() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                
                if (cloudAnimationId) {
                    cancelAnimationFrame(cloudAnimationId);
                    cloudAnimationId = null;
                }
                
                initialHeightInput.value = '';
                timeResultInput.value = '';
                velocityResultInput.value = '';
                initialVelocityInput.value = '0';
                gravitySelect.value = '9.8';
                customGravity.value = '';
                customGravityContainer.classList.add('hidden');
                calcTarget.value = 'all';
                simulateBtn.disabled = true;
                hasSimulated = false;
                resetSimulation();
                activeEquation.innerHTML = "Enter values and click 'Calculate' to see solution steps";
                updateCalcTargetOptions();
                resultSummary.classList.add('hidden');
                calculationResultCard.classList.add('hidden');
                
                // Reset tracking variables
                originalHeight = NaN;
                originalTime = NaN;
                originalVelocity = NaN;
                exactHeight = 0;
                exactTime = 0;
                exactVelocity = 0;
                knownValues = { height: false, time: false, velocity: false };
                calculatedTarget = '';
                
                // Reset input fields
                updateInputFieldsBasedOnTarget();
                
                // Clear all error messages
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.input-field').forEach(el => {
                    el.classList.remove('input-error');
                });
                
                // Remove calculated highlights
                heightCard.classList.remove('calculated');
                timeCard.classList.remove('calculated');
                velocityCard.classList.remove('calculated');
                
                // Update input helper
                checkInputs();
            }
            
            function validateInputs() {
                // Reset error states
                document.querySelectorAll('.input-field').forEach(input => {
                    input.classList.remove('input-error');
                });
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                });
                
                let isValid = true;
                const g = getGravityValue();
                
                // Validate gravity
                if (g <= 0) {
                    if (gravitySelect.value === 'custom') {
                        customGravity.classList.add('input-error');
                        document.getElementById('gravityError').style.display = 'block';
                    }
                    isValid = false;
                }
                
                // Validate height
                const height = parseFloat(initialHeightInput.value);
                if (!isNaN(height) && height < 0) {
                    initialHeightInput.classList.add('input-error');
                    document.getElementById('initialHeightError').textContent = "Height cannot be negative";
                    document.getElementById('initialHeightError').style.display = 'block';
                    isValid = false;
                }
                
                // Validate time
                const time = parseFloat(timeResultInput.value);
                if (!isNaN(time) && time < 0) {
                    timeResultInput.classList.add('input-error');
                    document.getElementById('timeResultError').textContent = "Time cannot be negative";
                    document.getElementById('timeResultError').style.display = 'block';
                    isValid = false;
                }
                
                // Validate velocity consistency
                const vi = parseFloat(initialVelocityInput.value) || 0;
                const vf = parseFloat(velocityResultInput.value);
                if (!isNaN(vf) && g > 0 && vf < vi) {
                    velocityResultInput.classList.add('input-error');
                    document.getElementById('velocityResultError').textContent = "Final velocity must be ≥ initial velocity";
                    document.getElementById('velocityResultError').style.display = 'block';
                    isValid = false;
                }
                
                return isValid;
            }
            
            function showError(fieldId, message) {
                const errorEl = document.getElementById(fieldId + 'Error');
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }
                const inputEl = document.getElementById(fieldId);
                if (inputEl) {
                    inputEl.classList.add('input-error');
                }
            }

            function startSimulation() {
                if (isSimulating || hasSimulated) return;
                
                if (isNaN(sim_initial_height) || sim_initial_height <= 0) {
                    showError('initialHeight', "Cannot simulate from zero/negative height");
                    return;
                }

                sim_time_elapsed = 0;
                sim_current_height = sim_initial_height;
                lastTimestamp = 0;
                isSimulating = true;
                isPaused = false;
                simulationActive = true;
                simulationEnded = false;
                hasSimulated = true;
                pauseBtnIcon.classList.remove('ri-play-line');
                pauseBtnIcon.classList.add('ri-pause-line');
                progressValue.style.width = '0%';
                scrubber.value = 0;
                sliderPositionValue.textContent = "0%";
                
                simStatus.innerHTML = `<span class="status-indicator status-running"></span>Running`;
                
                // Restore the last saved speed
                playbackSpeed.value = lastSpeedValue;
                simulationSpeed = lastSpeedValue;
                sliderSpeedValue.textContent = lastSpeedValue.toFixed(1) + "x";
                
                animationId = requestAnimationFrame(animateSimulation);
            }
            
            function animateSimulation(timestamp) {
                if (!isSimulating || isPaused) return;

                if (!lastTimestamp) lastTimestamp = timestamp;
                const deltaTime = (timestamp - lastTimestamp) / 1000 * simulationSpeed;
                lastTimestamp = timestamp;
                
                sim_time_elapsed += deltaTime;
                
                // Clamp time to totalTime to prevent overshoot
                if (sim_time_elapsed >= totalTime) {
                    sim_time_elapsed = totalTime;
                }
                
                // Update progress
                const progress = Math.min(100, (sim_time_elapsed / totalTime) * 100);
                progressValue.style.width = progress + '%';
                
                // Update scrubber
                scrubber.value = Math.min(1000, (sim_time_elapsed / totalTime) * 1000);
                sliderPositionValue.textContent = Math.round(progress) + "%";
                
                // Physics formula: h = h0 + v0*t - 0.5*g*t^2
                const calculatedCurrentHeight = sim_initial_height + 
                                              (sim_initial_v * sim_time_elapsed) - 
                                              (0.5 * sim_gravity * sim_time_elapsed * sim_time_elapsed);
                
                // Ensure we don't go below 0
                sim_current_height = Math.max(0, calculatedCurrentHeight);
                
                drawSimulation();
                
                // End simulation when we reach totalTime
                if (sim_time_elapsed >= totalTime) {
                    isSimulating = false;
                    simulationEnded = true;
                    simStatus.innerHTML = `<span class="status-indicator status-ended"></span>Completed`;
                    cancelAnimationFrame(animationId);
                    animationId = null;
                    return;
                }
                
                animationId = requestAnimationFrame(animateSimulation);
            }
            
            function togglePauseResume() {
                if (!simulationActive) return;
                
                isPaused = !isPaused;
                
                if (isPaused) {
                    pauseBtnIcon.classList.remove('ri-pause-line');
                    pauseBtnIcon.classList.add('ri-play-line');
                    simStatus.innerHTML = `<span class="status-indicator status-paused"></span>Paused`;
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                } else {
                    pauseBtnIcon.classList.remove('ri-play-line');
                    pauseBtnIcon.classList.add('ri-pause-line');
                    simStatus.innerHTML = `<span class="status-indicator status-running"></span>Running`;
                    lastTimestamp = 0;
                    animationId = requestAnimationFrame(animateSimulation);
                }
            }
            
            function replaySimulation() {
                resetSimulation();
                hasSimulated = false; // Allow simulation to run again
                startSimulation();
            }
            
            function resetSimulation() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                isSimulating = false;
                isPaused = false;
                simulationActive = false;
                simulationEnded = false;
                sim_time_elapsed = 0;
                sim_current_height = sim_initial_height;
                progressValue.style.width = '0%';
                simStatus.innerHTML = `<span class="status-indicator status-ready"></span>Ready`;
                scrubber.value = 0;
                sliderPositionValue.textContent = "0%";
                ballDataDisplay.style.display = 'none';
                
                drawSimulation();
            }
            
            // Update calculation options based on filled fields
            function updateCalcTargetOptions() {
                // Save current selection before updating
                const currentSelection = calcTarget.value;
                
                const hasHeight = !isNaN(parseFloat(initialHeightInput.value)) && parseFloat(initialHeightInput.value) >= 0;
                const hasTime = !isNaN(parseFloat(timeResultInput.value)) && parseFloat(timeResultInput.value) >= 0;
                const hasVelocity = !isNaN(parseFloat(velocityResultInput.value));
                
                let optionsHTML = '';
                optionsHTML += '<option value="all">All missing values</option>';
                if (!hasHeight) optionsHTML += '<option value="height">Initial Height</option>';
                if (!hasTime) optionsHTML += '<option value="time">Time to fall</option>';
                if (!hasVelocity) optionsHTML += '<option value="velocity">Final velocity</option>';
                
                // Update the options
                calcTarget.innerHTML = optionsHTML;
                
                // Restore previous selection if it's still available
                if (calcTarget.querySelector(`option[value="${currentSelection}"]`)) {
                    calcTarget.value = currentSelection;
                } else {
                    // Fallback to "all" if previous selection is no longer available
                    calcTarget.value = 'all';
                }
                
                // Update UI based on current target
                updateInputFieldsBasedOnTarget();
            }
            
            // Update input fields based on calculation target
            function updateInputFieldsBasedOnTarget() {
                const target = calcTarget.value;
                
                // Reset all sections
                heightInputSection.style.display = "block";
                timeInputSection.style.display = "block";
                velocityInputSection.style.display = "block";
                
                // Hide the section for the target variable
                if (target === 'height') {
                    heightInputSection.style.display = "none";
                } else if (target === 'time') {
                    timeInputSection.style.display = "none";
                } else if (target === 'velocity') {
                    velocityInputSection.style.display = "none";
                }
            }
            
            // Set simulation position based on scrubber
            function setSimulationPosition(value) {
                if (!simulationActive) return;
                
                const timeFraction = value / 1000;
                sim_time_elapsed = timeFraction * totalTime;
                
                // Update height
                sim_current_height = Math.max(0, sim_initial_height + 
                    (sim_initial_v * sim_time_elapsed) - 
                    (0.5 * sim_gravity * sim_time_elapsed * sim_time_elapsed));
                
                // Update progress bar
                const progress = timeFraction * 100;
                progressValue.style.width = progress + '%';
                sliderPositionValue.textContent = Math.round(progress) + "%";
                
                drawSimulation();
            }
            
            // Check if any inputs have values
            function checkInputs() {
                const hasHeight = initialHeightInput.value.trim() !== '';
                const hasTime = timeResultInput.value.trim() !== '';
                const hasVelocity = velocityResultInput.value.trim() !== '';
                
                if (hasHeight || hasTime || hasVelocity) {
                    inputHelper.style.display = 'none';
                } else {
                    inputHelper.style.display = 'block';
                }
            }
            
            // Toggle content visibility
            function toggleContent(toggleElement, contentElement) {
                const icon = toggleElement.querySelector('.toggle-icon');
                if (contentElement.classList.contains('collapsed')) {
                    contentElement.classList.remove('collapsed');
                    contentElement.classList.add('expanded');
                    icon.classList.remove('rotated');
                } else {
                    contentElement.classList.remove('expanded');
                    contentElement.classList.add('collapsed');
                    icon.classList.add('rotated');
                }
            }
            
            // Event listeners
            gravitySelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customGravityContainer.classList.remove('hidden');
                } else {
                    customGravityContainer.classList.add('hidden');
                }
            });
            
            calculateBtn.addEventListener('click', calculateFreeFall);
            simulateBtn.addEventListener('click', startSimulation);
            pauseResumeBtn.addEventListener('click', togglePauseResume);
            replayBtn.addEventListener('click', replaySimulation);
            resetAllBtn.addEventListener('click', resetAllFields);
            
            // Go to Simulation button functionality
            goToSimulationBtn.addEventListener('click', function() {
                document.getElementById('simulationSection').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            });
            
            // Input event listeners for helper text
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    updateCalcTargetOptions();
                    // Remove error state on input
                    this.classList.remove('input-error');
                    const errorEl = document.getElementById(this.id + 'Error');
                    if (errorEl) {
                        errorEl.style.display = 'none';
                    }
                    checkInputs();
                });
            });
            
            // Update simulation speed
            playbackSpeed.addEventListener('input', function() {
                simulationSpeed = parseFloat(this.value);
                lastSpeedValue = simulationSpeed; // Save the speed
                sliderSpeedValue.textContent = simulationSpeed.toFixed(1) + "x";
            });
            
            // Scrubber control
            scrubber.addEventListener('input', function() {
                setSimulationPosition(this.value);
            });
            
            // Update input fields when target changes
            calcTarget.addEventListener('change', updateInputFieldsBasedOnTarget);
            
            // Simulate button tooltip
            simulateBtn.addEventListener('mouseover', function() {
                if (simulateBtn.disabled) {
                    const tooltip = this.querySelector('.tooltip-content');
                    tooltip.style.opacity = '1';
                    tooltip.style.pointerEvents = 'auto';
                }
            });
            
            simulateBtn.addEventListener('mouseout', function() {
                const tooltip = this.querySelector('.tooltip-content');
                tooltip.style.opacity = '0';
                tooltip.style.pointerEvents = 'none';
            });
            
            // Toggle event listeners
            physicsEquationsToggle.addEventListener('click', function() {
                toggleContent(this, physicsEquationsContent);
            });
            
            solutionStepsToggle.addEventListener('click', function() {
                toggleContent(this, solutionStepsContent);
            });
            
            // Initialize
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            resetAllFields();
            updateCalcTargetOptions();
            updateInputFieldsBasedOnTarget();
            generateClouds();
            animateClouds();
            
            // Set initial slider display values
            sliderPositionValue.textContent = "0%";
            sliderSpeedValue.textContent = "1x";
            
            // Add smooth scrolling for navigation links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 80,
                            behavior: 'smooth'
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>